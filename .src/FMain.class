' Gambas class file

Public lineas As New String[]

Public Sub Form_Open()

  Me.center
  Labelversion.text = "Version: " & Application.Version

End

Public Sub Splitter1_Resize()

End

Public Sub ButtonPegarDatos_Click()

  Dim CONTENIDO As String

  Dim a As Integer
  Dim l As String
  Dim contador As Integer
  Dim token As String[]

  limpiar()
  TextAreaSalida.Visible = False
  If Clipboard.Text = 1 Then
    contenido = Clipboard.Paste("text/plain")
    LINEAS = Split(CONTENIDO, "\n")
    Print LINEAS.count
    contador = -1
    For Each l In lineas
      token = Split(l, "\t")

      If contador = -1 Then
        'cabecera
        gridviewOrigen.rows.Count = lineas.Count

        'redefino gridviewOrigen
        gridviewOrigen.Columns.Count = token.count
        gridviewOrigen.rows.Count = lineas.Count
        gridviewOrigen.Columns.Width = 150
        gridviewOrigen.Border = 2
        gridviewOrigen.Header = 3
        For a = 0 To token.Count - 1
          gridviewOrigen.Columns[a].title = a + 1
          gridviewOrigen.Columns[a].Alignment = Align.Center
        Next

      Endif
      contador += 1
      'relleno datos
      For a = 0 To token.count - 1
        'Si el dato esta vacio, pongo el dato del la fila anterior
        If token[a] <> "" Then
          If a = 0 Then
            'comprobacion de 1 columna que es la fecha quitar - y poner /
            gridviewOrigen[contador, a].Text = Trim(Replace(token[a], "-", "/"))
          Else
            gridviewOrigen[contador, a].Text = Trim(token[a])
          Endif

        Else
          'elimino espacio en blanco
          gridviewOrigen[contador, a].Text = Trim(gridviewOrigen[contador - 1, a].Text)
        Endif

      Next

    Next

  Endif

  Try TextBoxColumnaSENSOR.TEXT = gridviewOrigen[2, 1].Text

End

Public Sub ButtonOperar_Click()

  Dim FechaAnterior As String
  Dim a As Integer
  Dim contadorfecha As Integer
  Dim contadorlinea As Integer
  Dim valorAcumulado As Float

  If TextBoxColumnaDatos.Text = "" Then
    TextBoxColumnaDatos.Text = "0"
  Endif

  'cogo la columna 1 y 2, creo una con el nombre del sensor, y pongo el dato de la columna indicada
  With GridViewDestino
    .Clear()
    .columns.Count = 3
    .Header = 3

    .Columns[0].title = "fecha"
    .Columns[1].title = "sensor"
    .columns[2].title = "dato"
    .Border = 2
    .rows.Count = lineas.Count - 1
    .Columns.Width = 150
  End With

  'PONGO FECHA Y HORA (DEPENDE DEL VALOR DEL CheckButtonhora.Value
  If CheckButtonhora.Value = True Then
    Try GridViewDestino[0, 0].Text = GridViewOrigen[0, 0].text & " " & TextBoxHora.text
  Else
    Try GridViewDestino[0, 0].Text = GridViewOrigen[0, 0].text

  Endif

  'PONGO NOMBRE DE SENSOR
  GridViewDestino[0, 1].Text = TextBoxColumnaSENSOR.Text

  If Val(TextBoxColumnaDatos.Text) - 1 = -1 Then
    GridViewDestino[0, 2].Text = ""
  Else
    GridViewDestino[0, 2].Text = GridViewOrigen[0, Val(TextBoxColumnaDatos.Text) - 1].text
  Endif

  For a = 1 To lineas.count - 1
    If CheckButtonhora.Value = True Then
      Try GridViewDestino[a, 0].Text = GridViewOrigen[a, 0].text & " " & TextBoxHora.text
    Else
      Try GridViewDestino[a, 0].Text = GridViewOrigen[a, 0].text

    Endif

    Try GridViewDestino[a, 1].Text = TextBoxColumnaSENSOR.Text

    'en caso de columna valor 0, quedaria en valor -1 el textboxColumna datos, y se pondria valor ="" (seria una columna sin datos a recalcular DAMDATA)
    If Val(TextBoxColumnaDatos.Text) - 1 = -1 Then
      Try GridViewDestino[a, 2].Text = ""
    Else
      Try GridViewDestino[a, 2].Text = GridViewOrigen[a, Val(TextBoxColumnaDatos.Text) - 1].text
    Endif
  Next
  ButtonGenerar_Click()

End

Public Sub ButtonGenerar_Click()

  Dim a As Integer
  Dim lineas As String
  Dim contenido As String
  Dim iniciardatos As Integer

  'ENMPIEZO EN LA 1º LINEA -> las cabeceras ya estan eliminadas segun checkbox

  If CheckBoxCabecera.value Then
    'hay cabecera, se la quito
    iniciardatos = 1
  Else
    iniciardatos = 0
  Endif

  For a = iniciardatos To GridViewDestino.rows.count - 1
    lineas = GridViewDestino[a, 0].text & ";" & GridViewDestino[a, 1].text & ";" & GridViewDestino[a, 2].text & gb.CrLf 'for windows
    contenido &= lineas

  Next

  Clipboard.Copy(contenido)

  'SISTEMA DE REEMPLAZO PARA DATOS PROVENIENTES DEL SAIH, años 2018, 2019,2020,2021
  contenido = Replace(contenido, "/21 ", "/2021 ")
  contenido = Replace(contenido, "/20 ", "/2020 ")
  contenido = Replace(contenido, "/19 ", "/2019 ")
  contenido = Replace(contenido, "/18 ", "/2018 ")

  'muestro datos de salida generado
  TextAreaSalida.Visible = True
  TextAreaSalida.Text = contenido

  File.Save(User.home & "/PDF/test_" & TextBoxColumnaSENSOR.Text & ".csv", contenido)

  Message2.Info("Generado fichero en:" & gb.NewLine & User.home & "/pdf/test_" & TextBoxColumnaSENSOR.Text & ".csv")

End

Public Sub ButtonLimpiar_Click()

  limpiar()

End

Public Sub limpiar()

  TextBoxColumnaDatos.Text = ""
  TextBoxColumnaSENSOR.text = ""
  gridviewOrigen.Clear()
  GridViewDestino.Clear()
  lineas.Clear()

End

Public Sub GridViewOrigen_DblClick()

  Dim celdacontiene As String

  Try celdacontiene = gridviewOrigen[gridviewOrigen.Row, gridviewOrigen.Column].Text

  If Not IsNull(Val(celdacontiene)) Then
    TextBoxColumnaDatos.Text = gridviewOrigen.Column + 1

  Else
    Try TextBoxColumnaSENSOR.Text = celdacontiene
  Endif

  Clipboard.Copy(TextBoxColumnaSENSOR.Text)

End

Public Sub ButtonScript_Click()

  FormScript.formularioPrincipal = Me
  FormScript.Show()

End
