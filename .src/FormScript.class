' Gambas class file

Public formularioPrincipal As Object

Public Sub TextAreaSCRIPT_KeyPress()

End

Public Sub ButtonEjecutar_Click()

  Dim COMANDO As String[]
  Dim TOKEN As String[]
  Dim C As String
  Dim contador As Integer

  LabelProceso.Background = Color.green
  Wait 0.1
  'ejecutar
  comando = Split(TextAreaSCRIPT.text, "\n")

  For Each c In comando
    token = Split(c, ",")
    If token.count = 2 Then
      ejecutar(token[0], token[1])
    Endif
    If token.count = 1 Then
      'orden de operar
      ejecutar(token[0], "")
    Endif
    contador += 1
    LabelProceso.Text = Str$(contador) & " de " & Str$(comando.Count)
  Next

  Settings["scriptAnterior"] = TextAreaSCRIPT.text
  '  Message.Info("El script ha terminado de ejecutarse" & "\n" & "Ejecutadas: " & Str$(contador - 1) & " lineas de comandos")
  music.load("HongoMarioBross.wav")
  Music.Volume = 15
  music.play
  LabelProceso.Text = ""
  Me.close()

  LabelProceso.Background = Color.Default
  Wait 0.1

End

Public Sub ejecutar(lugar As String, valor As String)

  lugar = Upper(LUGAR)
  Select Case lugar
    Case Upper("TextBoxColumnaSENSOR")
      formularioPrincipal.TextBoxColumnaSENSOR.text = valor

    Case Upper("TextBoxColumnaDatos")
      formularioPrincipal.TextBoxColumnaDatos.text = valor

    Case Upper("CheckButtonhora")
      formularioPrincipal.CheckButtonhora.Value = If(Mid$(Upper(valor), 1, 1) = "T", True, False)

    Case Upper("CheckBoxCabecera")
      formularioPrincipal.CheckBoxCabecera.Value = If(Mid$(Upper(valor), 1, 1) = "T", True, False)

    Case Upper("TextBoxHora")
      If valor = "" Then valor = "08:00:00"
      formularioPrincipal.TextBoxHora.text = valor

    Case Upper("ButtonOperar_click()")
      formularioPrincipal.ButtonOperar_Click()

      While (formularioPrincipal.OperacionTerminada = False)
        Wait 0.1
        Print "espere..."
      Wend

      '  Wait 5'espero unos segundos despues de realizar calculos

  End Select

End

Public Sub Form_Open()

  Settings.Read(Me)

End

Public Sub ButtonRecuperarScript_Click()

  TextAreaSCRIPT.Text = settings["scriptAnterior", ""]

End

Public Sub ButtonReiniciarContenido_Click()

  TextAreaSCRIPT.Text = ButtonReiniciarContenido.tag

End

Public Sub Form_Close()

  Settings.Write(Me)

End

Public Sub ButtonGenerarScript_Click()

  Dim GridViewDATOS As GridView
  Dim A As Integer

  GridViewDATOS = formularioPrincipal.GridViewOrigen
  'la 1ยบ columna tiene fecha

  'empiezo en la 2ยบ columna
  TextAreaSCRIPT.Text = ""
  For a = 1 To (GridViewDATOS.Columns.Count - 1) Step 2
    TextAreaSCRIPT.Text &= "------------" & "\n"

    'Anular columnas con nombre "ANULAR"
    If CheckBoxcABECERA.Value = True Then
      If Upper(GridViewDATOS[1, a].Text) = "ANULAR" Then Continue 'PASA AL SIGUIENTE CICLO
    Else
      If Upper(GridViewDATOS[0, a].text) = "ANULAR" Then Continue 'PASA AL SIGUIENTE CICLO
    Endif

    If CheckBoxcABECERA.Value = True Then
      'hay cabecera de datos en el gridviewOrigen
      TextAreaSCRIPT.Text &= "TextBoxColumnaSENSOR," & GridViewDATOS[1, a].text & "\n" 'cogo dato de la fila 2 (se empieza a numerar por 0,1,2,3...)
    Else
      TextAreaSCRIPT.Text &= "TextBoxColumnaSENSOR," & GridViewDATOS[0, a].text & "\n"'cogo datos de la fila 1 (se empieza a numerar por 0,1,2,3...)
    Endif
    TextAreaSCRIPT.Text &= "TextBoxColumnaDatos," & Str(A + 2) & "\n"
    TextAreaSCRIPT.Text &= "CheckButtonhora," & If(CheckBoxHORA.VALUE, "T", "F") & "\n"
    TextAreaSCRIPT.Text &= "CheckBoxCabecera," & If(CheckBoxcABECERA.VALUE, "T", "F") & "\n"
    TextAreaSCRIPT.Text &= "TextBoxHora," & "\n"
    TextAreaSCRIPT.Text &= "ButtonOperar_click()" & "\n"
  Next

End
